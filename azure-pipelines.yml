trigger: none
pr: none

variables:
  - group: latin-secrets
  - name: SCRAPER_PATH
    value: src/Lemmatizer-LTN/tools/scrape_tables.py
  - name: LEMMA_CSV
    value: src/Lemmatizer-LTN/out/lemmas.csv
  - name: FORM_CSV
    value: src/Lemmatizer-LTN/out/forms.csv

pool:
  name: Default

steps:
  - powershell: |
      $ErrorActionPreference = 'Stop'

      # Allow the Python launcher to auto-install via winget if possible
      $env:PYLAUNCHER_ALLOW_INSTALL = "1"

      function Test-Py311 {
        try { & py -3.11 -c "import sys; print(sys.version)" | Out-Null; $true } catch { $false }
      }

      if (-not (Test-Py311)) {
        Write-Host "Python 3.11 not found. Attempting installation via winget..."
        try {
          winget source update | Out-Null
          winget install -e --id Python.Python.3.11 `
            --accept-source-agreements --accept-package-agreements --silent
        } catch {
          Write-Warning "winget install failed; falling back to python.org installer."
          $url = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-amd64.exe"
          $exe = Join-Path $env:TEMP "py311-installer.exe"
          Invoke-WebRequest -Uri $url -OutFile $exe
          & $exe /quiet InstallAllUsers=0 PrependPath=1 Include_pip=1 TargetDir="$env:LocalAppData\Programs\Python\Python311"
        }
      }

      # Verify and set up the venv
      & py -3.11 --version
      & py -3.11 -m pip install -U pip
      & py -3.11 -m venv .venv

      # Activate and install your requirements
      Set-ExecutionPolicy Bypass -Scope Process -Force
      .\.venv\Scripts\Activate.ps1
      pip install -r etl/requirements.txt
    displayName: "Install Python 3.11 if missing + deps"

  - powershell: |
      $ErrorActionPreference = 'Stop'
      $bytes = [Convert]::FromBase64String($env:GOOGLE_SERVICE_ACCOUNT_JSON_BASE64)
      [IO.File]::WriteAllBytes("service_account.json", $bytes)
    displayName: "Materialize Google SA JSON"
    env:
      GOOGLE_SERVICE_ACCOUNT_JSON_BASE64: $(GOOGLE_SERVICE_ACCOUNT_JSON_BASE64)

  - powershell: |
      $ErrorActionPreference = 'Stop'
      .\.venv\Scripts\Activate.ps1
      python "$(SCRAPER_PATH)" --lemmas-out "$(LEMMA_CSV)" --forms-out "$(FORM_CSV)"
    displayName: "Scrape â†’ CSVs"

  - powershell: |
      $ErrorActionPreference = 'Stop'
      .\.venv\Scripts\Activate.ps1
      python etl/upload_to_drive.py `
        --service-account-json service_account.json `
        --folder-id "$(GOOGLE_DRIVE_FOLDER_ID)" `
        --files "$(LEMMA_CSV)" "$(FORM_CSV)"
    displayName: "Upload CSVs to Google Drive"
    env:
      GOOGLE_DRIVE_FOLDER_ID: $(GOOGLE_DRIVE_FOLDER_ID)

  - powershell: |
      $ErrorActionPreference = 'Stop'
      .\.venv\Scripts\Activate.ps1

      $script = @'
      import os, subprocess, sys
      import psycopg2

      dsn = os.environ["DATABASE_URL"]
      sql_path = os.path.join("ops", "init_db.sql")

      with open(sql_path, "r", encoding="utf-8") as f:
          init_sql = f.read()

      with psycopg2.connect(dsn) as conn:
          with conn.cursor() as cur:
              cur.execute(init_sql)

      print("Schema initialized.")

      subprocess.check_call([
          sys.executable, "etl/load_to_postgres.py",
          "--db", dsn,
          "--lemmas", os.environ["LEMMA_CSV"],
          "--forms",  os.environ["FORM_CSV"],
      ])
      '@

      $scriptPath = Join-Path $PWD "run_init_and_load.py"
      Set-Content -Path $scriptPath -Value $script -Encoding UTF8
      python $scriptPath
    displayName: "Init schema + Load CSVs"
    env:
      DATABASE_URL: $(DATABASE_URL)
      LEMMA_CSV: $(LEMMA_CSV)
      FORM_CSV: $(FORM_CSV)
